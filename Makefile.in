
# Main Makefile for MPI_START
all:
	$(MAKE) -C src all 
	$(MAKE) -C modules all
	$(MAKE) -C templates all
	$(MAKE) -C docs all
	$(MAKE) -C tests all 

clean:
	rm -f *.tar.gz
	rm -rf bin etc
	$(MAKE) -C src clean
	$(MAKE) -C modules clean
	$(MAKE) -C templates clean
	$(MAKE) -C docs clean
	$(MAKE) -C tests clean

distclean:clean

install: all
	install -d $(DESTDIR)/$(bindir) $(DESTDIR)/$(sysconfdir) $(DESTDIR)/$(moduledir) 
	$(MAKE) -C src install
	$(MAKE) -C modules install
	$(MAKE) -C templates install
	$(MAKE) -C docs install
	$(MAKE) -C tests install 
	install -d $(DESTDIR)/$(sysconfdir)/profile.d
	echo "export I2G_MPI_START=$(bindir)/mpi-start" > \
					$(DESTDIR)/$(sysconfdir)/profile.d/mpi_start.sh
	echo "setenv I2G_MPI_START $(bindir)/mpi-start" > \
					$(DESTDIR)/$(sysconfdir)/profile.d/mpi_start.csh

tarball: all
	mkdir -p bin
	mkdir -p etc
	$(MAKE) -C src install DESTDIR=`pwd` prefix="" 
	$(MAKE) -C modules install DESTDIR=`pwd` prefix="" 
	tar czf mpi-start-$(VERSION).tar.gz bin/* etc/*

DISTFILES=src\
modules\
docs\
templates \
tests \
configure \
ChangeLog \
Makefile.in \
README \
VERSION

dist:	
	rm -rf $(name_prefix)mpi-start-$(VERSION)
	# what if hg is not here!
	# hg archive $(name_prefix)mpi-start-$(VERSION)
	mkdir $(name_prefix)mpi-start-$(VERSION)
	cp -a $(DISTFILES) $(name_prefix)mpi-start-$(VERSION)
	tar czf $(name_prefix)mpi-start-$(VERSION).tar.gz $(name_prefix)mpi-start-$(VERSION)
	rm -rf $(name_prefix)mpi-start-$(VERSION)

rpm: dist 
	mkdir -p rpms/SOURCES rpms/SRPMS rpms/SPECS rpms/BUILD rpms/RPMS
	cp $(name_prefix)mpi-start-$(VERSION).tar.gz rpms/SOURCES
	sed -e "s/@NAME_PREFIX@/$(name_prefix)/" \
		-e "s/@VERSION@/$(VERSION)/" mpi-start.spec.in \
		> rpms/SPECS/$(name_prefix)mpi-start.spec
	rpmbuild --define "_topdir `pwd`/rpms" -bs rpms/SPECS/$(name_prefix)mpi-start.spec
	rpmbuild $(PACKAGER) --define "_topdir `pwd`/rpms" -bb rpms/SPECS/$(name_prefix)mpi-start.spec


maintainer-clean: clean
	rm -rf rpms 
	rm -f $(maintainerclean_files)

export VERSION
export prefix
export DESTDIR
export exec_prefix
export bindir
export datadir
export docdir
export moduledir
export sysconfdir
export mandir 
export name_prefix

